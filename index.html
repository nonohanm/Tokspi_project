<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <title>ì¦ê¶Œ+</title>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .friend-item.selected-kakao { background-color: #FFFBEB; border: 2px dashed #FBBF24; }
        .friend-item.selected-line { background-color: #F0FFF4; border: 2px dashed #4ADE80; }
        .rwa-mode-bg { background-color: #F0FDFA; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="w-full max-w-sm mx-auto bg-white font-sans shadow-lg relative" style="min-height: 100vh;">

        <div id="main-view">
            <header class="bg-white p-4 border-b sticky top-0 z-10">
                <h1 id="header-title" class="text-xl font-bold text-gray-800">ì¦ê¶Œ+</h1>
            </header>

            <main class="p-4 pb-20">
                <div id="exchange-content" class="content-section">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">ì•”í˜¸í™”í</h2>
                    <ul id="crypto-list">
                        <li class="asset-item flex justify-between items-center py-3 border-b cursor-pointer" data-type="crypto" data-symbol="BITHUMB:BTCKRW" data-name="ë¹„íŠ¸ì½”ì¸">
                            <div><p class="font-semibold">ë¹„íŠ¸ì½”ì¸ (BTC)</p><p class="text-sm text-gray-500">ê±°ë˜ëŒ€ê¸ˆ -</p></div>
                            <div class="text-right"><p class="font-semibold price">Loading...</p><p class="text-sm change"> </p></div>
                        </li>
                        <li class="asset-item flex justify-between items-center py-3 border-b cursor-pointer" data-type="crypto" data-symbol="BITHUMB:ETHKRW" data-name="ì´ë”ë¦¬ì›€">
                            <div><p class="font-semibold">ì´ë”ë¦¬ì›€ (ETH)</p><p class="text-sm text-gray-500">ê±°ë˜ëŒ€ê¸ˆ -</p></div>
                            <div class="text-right"><p class="font-semibold price">Loading...</p><p class="text-sm change"> </p></div>
                        </li>
                        <li class="asset-item flex justify-between items-center py-3 border-b cursor-pointer" data-type="crypto" data-symbol="BITHUMB:USDTKRW" data-name="í…Œë”">
                            <div><p class="font-semibold">í…Œë” (USDT)</p><p class="text-sm text-gray-500">ê±°ë˜ëŒ€ê¸ˆ -</p></div>
                            <div class="text-right"><p class="font-semibold price">Loading...</p><p class="text-sm change"> </p></div>
                        </li>
                        <li class="asset-item flex justify-between items-center py-3 border-b cursor-pointer" data-type="crypto" data-symbol="BITHUMB:KAIAKRW" data-name="ì¹´ì´ì•„">
                            <div><p class="font-semibold">ì¹´ì´ì•„ (KAIA)</p><p class="text-sm text-gray-500">ê±°ë˜ëŒ€ê¸ˆ -</p></div>
                            <div class="text-right"><p class="font-semibold price">Loading...</p><p class="text-sm change"> </p></div>
                        </li>
                        <li class="asset-item flex justify-between items-center py-3 border-b cursor-pointer" data-type="crypto" data-symbol="KKRW" data-name="KKRW">
                            <div><p class="font-semibold">KKRW (KKRW)</p><p class="text-sm text-gray-500">ê±°ë˜ëŒ€ê¸ˆ -</p></div>
                            <div class="text-right"><p class="font-semibold price">Loading...</p><p class="text-sm change"></p></div>
                        </li>
                    </ul>
                    <section class="mt-8">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">ì£¼ì‹</h2>
                         <ul id="stock-list">
                            <li class="asset-item flex justify-between items-center py-3 border-b cursor-pointer" data-type="stock" data-symbol="035720.KS" data-name="ì¹´ì¹´ì˜¤">
                                <div><p class="font-semibold">ì¹´ì¹´ì˜¤ (Kakao)</p><p class="text-sm text-gray-500">ê±°ë˜ëŒ€ê¸ˆ -</p></div>
                                <div class="text-right"><p class="font-semibold price">Loading...</p><p class="text-sm change"> </p></div>
                            </li>
                            <li class="asset-item flex justify-between items-center py-3 border-b cursor-pointer" data-type="stock" data-symbol="377300.KS" data-name="ì¹´ì¹´ì˜¤í˜ì´">
                                <div><p class="font-semibold">ì¹´ì¹´ì˜¤í˜ì´ (Kakaopay)</p><p class="text-sm text-gray-500">ê±°ë˜ëŒ€ê¸ˆ -</p></div>
                                <div class="text-right"><p class="font-semibold price">Loading...</p><p class="text-sm change"> </p></div>
                            </li>
                            <li class="asset-item flex justify-between items-center py-3 border-b cursor-pointer" data-type="stock" data-symbol="323410.KS" data-name="ì¹´ì¹´ì˜¤ë±…í¬">
                                <div><p class="font-semibold">ì¹´ì¹´ì˜¤ë±…í¬ (Kakaobank)</p><p class="text-sm text-gray-500">ê±°ë˜ëŒ€ê¸ˆ -</p></div>
                                <div class="text-right"><p class="font-semibold price">Loading...</p><p class="text-sm change"> </p></div>
                            </li>
                            <li class="asset-item flex justify-between items-center py-3 border-b cursor-pointer" data-type="stock" data-symbol="4689.T" data-name="ë¼ì¸ (LY Corporation)">
                                <div><p class="font-semibold">ë¼ì¸ (LY Corp)</p><p class="text-sm text-gray-500">ê±°ë˜ëŒ€ê¸ˆ -</p></div>
                                <div class="text-right"><p class="font-semibold price">Loading...</p><p class="text-sm change"> </p></div>
                            </li>
                        </ul>
                    </section>
                </div>
                <div id="search-content" class="content-section hidden"></div>
                <div id="history-content" class="content-section hidden"></div>
                <div id="transfer-content" class="content-section hidden"></div>
                <div id="more-content" class="content-section hidden"></div>
            </main>

            <footer class="fixed bottom-0 w-full max-w-sm mx-auto bg-white border-t">
                <div class="flex justify-around items-center h-16">
                    <div class="nav-item text-center text-blue-600 cursor-pointer" data-tab="exchange" data-title="ì¦ê¶Œ+"><span class="text-2xl">ğŸ“Š</span><p class="text-xs font-semibold">ì¦ê¶Œ+</p></div>
                    <div class="nav-item text-center text-gray-500 cursor-pointer" data-tab="search" data-title="ê²€ìƒ‰"><span class="text-2xl">ğŸ”</span><p class="text-xs">ê²€ìƒ‰</p></div>
                    <div class="nav-item text-center text-gray-500 cursor-pointer" data-tab="history" data-title="íˆ¬ìë‚´ì—­"><span class="text-2xl">ğŸ’°</span><p class="text-xs">íˆ¬ìë‚´ì—­</p></div>
                    <div class="nav-item text-center text-gray-500 cursor-pointer" data-tab="transfer" data-title="ìì‚°"><span class="text-2xl">ğŸ’¼</span><p class="text-xs">ìì‚°</p></div>
                    <div class="nav-item text-center text-gray-500 cursor-pointer" data-tab="more" data-title="ë”ë³´ê¸°"><span class="text-2xl">â˜°</span><p class="text-xs">ë”ë³´ê¸°</p></div>
                </div>
            </footer>
        </div>

        <div id="detail-view" class="hidden">
            <header class="bg-white p-4 border-b flex items-center sticky top-0 z-10">
                <button id="back-button" class="text-2xl mr-4 font-bold">â€¹</button>
                <div><h1 id="detail-name" class="text-xl font-bold text-gray-800"></h1><p id="detail-symbol" class="text-sm text-gray-500"></p></div>
            </header>
            <div id="detail-content-container" class="w-full flex-grow flex flex-col"></div>
        </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        // ë°ì´í„°
        const FEE_RATES = { CRYPTO: 0.0005, RWA: 0.0005, STOCK: 0.0015 };
        const KAIA_BENEFIT_THRESHOLD = 500;
        const appState = { displayCurrency: 'Default', linkedAccounts: { kakao: false, line: false }, tradeMode: 'standard', rwaTradeType: 'spot', leverage: 1, position: 'long' };
        const exchangeRates = { KRW: 1, JPY: 8.5, KKRW: 1000, USDT: 1384.41 };
        const userWallet = { 
            KRW: 1000000, 
            JPY: 5000, 
            assets: { 
                'BITHUMB:USDTKRW': { name: 'í…Œë”', ticker: 'USDT', quantity: 1000 },
                'BITHUMB:ETHKRW': { name: 'ì´ë”ë¦¬ì›€', ticker: 'ETH', quantity: 10 },
                'BITHUMB:KAIAKRW': { name: 'ì¹´ì´ì•„', ticker: 'KAIA', quantity: 650 }, 
                'KKRW': { name: 'KKRW', ticker: 'KKRW', quantity: 1800 }, 
                '035720.KS': { name: 'ì¹´ì¹´ì˜¤', ticker: 'KAKAO', quantity: 10 }, 
                '4689.T': { name: 'ë¼ì¸', ticker: 'LINE', quantity: 20 } 
            },
            stakedAssets: [] 
        };
        const mockApi = { basePrices: { 
            "BITHUMB:BTCKRW": { name: 'ë¹„íŠ¸ì½”ì¸', type: 'crypto', price: 9437280.96, currency: 'KRW', apy: 3.0 }, 
            "BITHUMB:ETHKRW": { name: 'ì´ë”ë¦¬ì›€', type: 'crypto', price: 5909558.76, currency: 'KRW', apy: 4.5 }, 
            "BITHUMB:USDTKRW": { name: 'í…Œë”', type: 'crypto', price: 1384.41, currency: 'KRW', apy: 6.0 },
            "BITHUMB:KAIAKRW": { name: 'ì¹´ì´ì•„', type: 'crypto', price: 208.25, currency: 'KRW', apy: 7.5 }, 
            "KKRW": { name: 'KKRW', type: 'crypto', price: 1000, currency: 'KRW', apy: 0 }, 
            "035720.KS": { name: 'ì¹´ì¹´ì˜¤', type: 'stock', price: 43500, currency: 'KRW' },
            "377300.KS": { name: 'ì¹´ì¹´ì˜¤í˜ì´', type: 'stock', price: 62100, currency: 'KRW' },
            "323410.KS": { name: 'ì¹´ì¹´ì˜¤ë±…í¬', type: 'stock', price: 25200, currency: 'KRW' },
            "4689.T": { name: 'ë¼ì¸ (LY Corporation)', type: 'stock', price: 385, currency: 'JPY' }, 
            '005930.KS': { name: 'ì‚¼ì„±ì „ì', type: 'stock', price: 71600, currency: 'KRW' },
            '000660.KS': { name: 'SKí•˜ì´ë‹‰ìŠ¤', type: 'stock', price: 276500, currency: 'KRW' },
            '373220.KS': { name: 'LGì—ë„ˆì§€ì†”ë£¨ì…˜', type: 'stock', price: 394000, currency: 'KRW' },
            '207940.KS': { name: 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', type: 'stock', price: 1033000, currency: 'KRW' },
            '005935.KS': { name: 'ì‚¼ì„±ì „ììš°', type: 'stock', price: 58200, currency: 'KRW' },
            '012450.KS': { name: 'í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤', type: 'stock', price: 883000, currency: 'KRW' },
            '005380.KS': { name: 'í˜„ëŒ€ì°¨', type: 'stock', price: 217500, currency: 'KRW' },
            '105560.KS': { name: 'KBê¸ˆìœµ', type: 'stock', price: 113200, currency: 'KRW' },
            '329180.KS': { name: 'HDí˜„ëŒ€ì¤‘ê³µì—…', type: 'stock', price: 477000, currency: 'KRW' },
            '034020.KS': { name: 'ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°', type: 'stock', price: 65500, currency: 'KRW' }
        }, fetchRealTimeData: async function(symbols) { await new Promise(resolve => setTimeout(resolve, 300)); const results = {}; symbols.forEach(symbol => { if (this.basePrices[symbol]) { const baseInfo = this.basePrices[symbol]; let currentPrice = baseInfo.price; let changePercent = 0; if (symbol !== 'KKRW') { const fluctuation = baseInfo.price * 0.03; const change = (Math.random() - 0.5) * fluctuation; currentPrice = baseInfo.price + change; changePercent = (change / baseInfo.price) * 100; } results[symbol] = { price: currentPrice, changePercent: changePercent, currency: baseInfo.currency }; } }); return results; } };
        const Hangul = { CHO: ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"], JUNG: ["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"], JONG: ["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"], disassemble: function(text) { let result = ""; for (let i = 0; i < text.length; i++) { const charCode = text.charCodeAt(i); if (charCode >= 44032 && charCode <= 55203) { const jong = charCode - 44032; const cho = Math.floor(jong / 588); const jung = Math.floor((jong - cho * 588) / 28); result += this.CHO[cho] + this.JUNG[jung]; if (jong % 28 > 0) result += this.JONG[jong % 28]; } else { result += text[i]; } } return result; }, includes: function(base, search) { if (!search) return true; return this.disassemble(base).includes(this.disassemble(search)); } };
        const mockFriends = [ { name: 'ê¹€ë¯¼ì¤€', platform: 'kakao' }, { name: 'ì´ì„œì—°', platform: 'line' }, { name: 'ë°•ë„ìœ¤', platform: 'kakao' }, { name: 'ìµœì§€ìš°', platform: 'line' } ];
        
        const mainView = document.getElementById('main-view'), detailView = document.getElementById('detail-view'), detailContentContainer = document.getElementById('detail-content-container');

        google.charts.load('current', {'packages':['corechart']});

        // ê³„ì‚°ê¸°
        function isKaiaBenefitActive() {
            return userWallet.stakedAssets.some(asset => 
                asset.symbol === 'BITHUMB:KAIAKRW' &&
                asset.duration === 14 &&
                asset.quantity >= KAIA_BENEFIT_THRESHOLD
            );
        }
        function convertToDisplayCurrency(value, fromCurrency) { if (appState.displayCurrency === 'Default') { return { value: value, currency: 'KRW' }; } const valueInKRW = value * (exchangeRates[fromCurrency] || 1); const displayRate = exchangeRates[appState.displayCurrency] || 1; const convertedValue = valueInKRW / displayRate; return { value: convertedValue, currency: appState.displayCurrency }; }
        async function updateAllPrices() { const assetElements = document.querySelectorAll('.asset-item'); const symbols = Array.from(assetElements).map(el => el.dataset.symbol); const liveData = await mockApi.fetchRealTimeData(symbols); assetElements.forEach(el => { const symbol = el.dataset.symbol; if (liveData[symbol]) { const data = liveData[symbol]; el.dataset.currency = data.currency; const displayData = convertToDisplayCurrency(data.price, data.currency); const priceEl = el.querySelector('.price'); const changeEl = el.querySelector('.change'); priceEl.textContent = `${displayData.value.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${displayData.currency}`; changeEl.textContent = `${data.changePercent.toFixed(2)}%`; priceEl.classList.toggle('text-red-600', data.changePercent > 0); priceEl.classList.toggle('text-blue-600', data.changePercent < 0); changeEl.classList.toggle('text-red-600', data.changePercent > 0); changeEl.classList.toggle('text-blue-600', data.changePercent < 0); } }); }
        
        // í™”ë©´ ë Œë”ë§ í•¨ìˆ˜ë“¤ 
        function renderSearchUI() { const container = document.getElementById('search-content'); container.innerHTML = `<div class="relative"><input type="text" id="search-input" placeholder="ì¢…ëª©ëª… ê²€ìƒ‰" class="w-full p-3 pl-10 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">ğŸ”</span></div><ul id="search-results-list" class="mt-4"></ul>`; const allStocks = Object.entries(mockApi.basePrices).filter(([, data]) => data.type === 'stock').map(([symbol, data]) => ({...data, symbol})); displaySearchResults(allStocks); }
        function displaySearchResults(assets) { const listContainer = document.getElementById('search-results-list'); if (assets.length === 0) { listContainer.innerHTML = '<li class="text-center text-gray-500 py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>'; return; } listContainer.innerHTML = assets.map(asset => `<li class="asset-item flex justify-between items-center py-3 border-b cursor-pointer" data-type="stock" data-symbol="${asset.symbol}" data-name="${asset.name}" data-currency="${asset.currency}"><div ><p class="font-semibold">${asset.name}</p><p class="text-sm text-gray-500">${asset.symbol}</p></div><div class="text-right font-semibold price">${asset.price.toLocaleString()} ${asset.currency}</div></li>`).join(''); }
        function renderHistoryUI() { const container = document.getElementById('history-content'); container.innerHTML = `<div class="mb-6"><h2 class="text-lg font-bold text-gray-800 mb-2">í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼</h2><div id="performance-chart" class="w-full h-48 bg-gray-50 rounded-lg"></div></div><div class="mb-6"><h2 class="text-lg font-bold text-gray-800 mb-2">ìì‚° ë°°ë¶„</h2><div id="allocation-chart" class="w-full h-64 bg-gray-50 rounded-lg"></div></div><div><h2 class="text-lg font-bold text-gray-800 mb-2">ìš”ì•½</h2><div class="space-y-3"><div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><p class="font-semibold">ì´ë²ˆë…„ë„ ìˆ˜ìµë¥ </p><p class="font-bold text-red-600">+15.72%</p></div><div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><p class="font-semibold">ì´ë²ˆë…„ë„ ë°°ë‹¹ê¸ˆ</p><p class="font-bold text-blue-600">35,000 KRW</p></div><div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><p class="font-semibold">ì´ ìˆ˜ìµë¥ </p><p class="font-bold text-red-600">+23.40%</p></div></div></div>`; google.charts.setOnLoadCallback(drawPerformanceChart); google.charts.setOnLoadCallback(drawAllocationChart); }
        function renderAssetsUI() {
            const container = document.getElementById('transfer-content');
            const fiatHtml = Object.keys(userWallet).filter(k => k !== 'assets' && k !== 'stakedAssets').map(key => {
                const asset = { name: key === 'KRW' ? 'ëŒ€í•œë¯¼êµ­ ì›' : 'ì¼ë³¸ ì—”', ticker: key, quantity: userWallet[key] };
                return `<li class="flex justify-between items-center py-4 border-b"><div><p class="font-semibold">${asset.name} (${asset.ticker})</p><p class="text-sm text-gray-600">ë³´ìœ ì•¡: ${asset.quantity.toLocaleString()}</p></div><button class="fiat-send-btn bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-600" data-asset-symbol="${asset.ticker}">ì…ê¸ˆ/ì†¡ê¸ˆ</button></li>`
            }).join('');

            const cryptoHtml = Object.keys(userWallet.assets).filter(symbol => mockApi.basePrices[symbol]?.type === 'crypto' || userWallet.assets[symbol].rwaOriginalSymbol).map(symbol => {
                const asset = userWallet.assets[symbol];
                let quantityText = `ë³´ìœ ìˆ˜ëŸ‰: ${asset.quantity.toLocaleString()}`;

                if (asset.rwaOriginalSymbol) {
                    const originalAssetInfo = mockApi.basePrices[asset.rwaOriginalSymbol];
                    const valueInKRW = asset.quantity * originalAssetInfo.price * (exchangeRates[originalAssetInfo.currency] || 1);
                    const displayData = convertToDisplayCurrency(valueInKRW, 'KRW');
                    quantityText += ` (${displayData.value.toLocaleString()} ${displayData.currency})`;
                } else if (asset.ticker === 'KKRW') {
                    const valueInKRW = asset.quantity * 1000;
                    const displayData = convertToDisplayCurrency(valueInKRW, 'KRW');
                    quantityText += ` (${displayData.value.toLocaleString()} ${displayData.currency})`;
                }

                const isStakeable = mockApi.basePrices[symbol]?.type === 'crypto' && !asset.rwaOriginalSymbol && symbol !== 'KKRW';
                let buttonsHtml = `<button class="send-btn bg-blue-500 text-white px-3 py-2 rounded text-sm font-bold hover:bg-blue-600" data-asset-symbol="${symbol}">ì…ê¸ˆ/ì†¡ê¸ˆ</button>`;
                if (isStakeable) {
                    buttonsHtml += `<button class="stake-btn bg-purple-500 text-white px-3 py-2 rounded text-sm font-bold hover:bg-purple-600" data-asset-symbol="${symbol}">ìŠ¤í…Œì´í‚¹</button>`;
                }

                return `<li class="flex justify-between items-center py-4 border-b">
                            <div>
                                <p class="font-semibold">${asset.name} (${asset.ticker})</p>
                                <p class="text-sm text-gray-600">${quantityText}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                ${buttonsHtml}
                            </div>
                        </li>`;
            }).join('');

            const stockHtml = Object.keys(userWallet.assets).filter(symbol => mockApi.basePrices[symbol]?.type === 'stock' && !userWallet.assets[symbol].rwaOriginalSymbol).map(symbol => {
                const asset = userWallet.assets[symbol];
                return `<li class="flex justify-between items-center py-4 border-b"><div><p class="font-semibold">${asset.name} (${asset.ticker})</p><p class="text-sm text-gray-600">ë³´ìœ ìˆ˜ëŸ‰: ${asset.quantity.toLocaleString()}</p></div></li>`;
            }).join('');

            container.innerHTML = `<h2 class="text-lg font-bold text-gray-800 mb-2">ë³´ìœ  í˜„ê¸ˆ</h2><ul>${fiatHtml}</ul><h2 class="text-lg font-bold text-gray-800 mt-8 mb-2">ì•”í˜¸í™”í</h2><ul>${cryptoHtml}</ul><h2 class="text-lg font-bold text-gray-800 mt-8 mb-2">ë³´ìœ  ì£¼ì‹</h2><ul>${stockHtml}</ul>`;
        }
        function renderSettingsUI() {
            const container = document.getElementById('more-content');
            const currencies = ['Default', 'KRW', 'JPY', 'KKRW', 'USDT'];
            const currencyButtonsHtml = currencies.map(currency => { const isSelected = appState.displayCurrency === currency; const currencyText = currency === 'Default' ? 'ê¸°ë³¸' : currency; return `<button class="currency-btn w-full p-3 text-left rounded-md ${isSelected ? 'bg-blue-500 text-white' : 'bg-gray-200'}" data-currency="${currency}">${currencyText}</button>` }).join('');
            
            const kaiaBenefitActive = isKaiaBenefitActive();
            const kaiaBenefitHtml = kaiaBenefitActive ? `<p class="text-sm text-green-600 font-bold mb-2">âœ¨ ì¹´ì´ì•„ 14ì¼ ìŠ¤í…Œì´í‚¹ í˜œíƒ ì ìš© ì¤‘</p>` : '';

            const stakedAssetsHtml = userWallet.stakedAssets.length === 0 
                ? '<p class="text-sm text-gray-500">ìŠ¤í…Œì´í‚¹ ì¤‘ì¸ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</p>' 
                : userWallet.stakedAssets.map((asset, index) => {
                    const assetInfo = mockApi.basePrices[asset.symbol];
                    const timePassed = (Date.now() - asset.startDate) / (1000 * 60 * 60 * 24);
                    const daysRemaining = Math.max(0, asset.duration - timePassed);
                    return `<li class="flex justify-between items-center py-3 border-b">
                                <div>
                                    <p class="font-semibold">${assetInfo.name} (${asset.quantity.toLocaleString()} ê°œ)</p>
                                    <p class="text-sm text-gray-500">${asset.duration}ì¼ (${daysRemaining.toFixed(1)}ì¼ ë‚¨ìŒ)</p>
                                </div>
                                <button class="unstake-btn bg-red-500 text-white px-3 py-2 rounded text-sm font-bold" data-stake-index="${index}">í•´ì§€</button>
                            </li>`;
                }).join('');

            const kakaoLinked = appState.linkedAccounts.kakao;
            const lineLinked = appState.linkedAccounts.line;

            const rwaAssets = Object.keys(userWallet.assets).filter(symbol => userWallet.assets[symbol].rwaOriginalSymbol && userWallet.assets[symbol].isSpot).map(symbol => ({...userWallet.assets[symbol], rwaSymbol: symbol }));
            const rwaHtml = rwaAssets.length === 0 ? '<p class="text-sm text-gray-500">êµí™˜ ê°€ëŠ¥í•œ RWA í˜„ë¬¼ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : rwaAssets.map(asset => `<li class="flex justify-between items-center py-3 border-b" data-rwa-symbol="${asset.rwaSymbol}"><div><p class="font-semibold">${asset.name}</p><p class="text-sm text-gray-500">ë³´ìœ ìˆ˜ëŸ‰: ${asset.quantity.toLocaleString()}</p></div><button class="swap-rwa-btn bg-green-500 text-white px-4 py-2 rounded text-sm font-bold">êµí™˜í•˜ê¸°</button></li>`).join('');

            container.innerHTML = `<h2 class="text-lg font-bold text-gray-800 mb-4">ìŠ¤í…Œì´í‚¹ í˜„í™©</h2>${kaiaBenefitHtml}<ul id="staked-assets-list">${stakedAssetsHtml}</ul><hr class="my-6"><h2 class="text-lg font-bold text-gray-800 mb-4">í†µí™” ì„¤ì •</h2><div class="space-y-2 mb-8">${currencyButtonsHtml}</div><h2 class="text-lg font-bold text-gray-800 mb-4">ê³„ì • ì—°ë™</h2><p class="text-sm text-gray-500 -mt-2 mb-4">ì—°ë™í•˜ë©´ ì¹œêµ¬ë“¤ì—ê²Œ ê°„í¸í•˜ê²Œ ì†¡ê¸ˆì´ ê°€ëŠ¥í•´ìš”!</p><div class="space-y-2 mb-8"><div class="flex justify-between items-center p-3 rounded-md ${kakaoLinked ? 'bg-yellow-100' : 'bg-gray-100'}"><p class="font-semibold">ì¹´ì¹´ì˜¤ ê³„ì •</p><button class="link-account-btn px-4 py-2 text-sm font-bold rounded ${kakaoLinked ? 'bg-gray-400 text-white' : 'bg-yellow-400'}" data-platform="kakao">${kakaoLinked ? 'ì—°ë™ë¨' : 'ì—°ë™í•˜ê¸°'}</button></div><div class="flex justify-between items-center p-3 rounded-md ${lineLinked ? 'bg-green-100' : 'bg-gray-100'}"><p class="font-semibold">ë¼ì¸ ê³„ì •</p><button class="link-account-btn px-4 py-2 text-sm font-bold rounded ${lineLinked ? 'bg-gray-400 text-white' : 'bg-green-500 text-white'}" data-platform="line">${lineLinked ? 'ì—°ë™ë¨' : 'ì—°ë™í•˜ê¸°'}</button></div></div><h2 class="text-lg font-bold text-gray-800 mb-4">RWA í† í° êµí™˜ (í˜„ë¬¼)</h2><ul id="rwa-swap-list">${rwaHtml}</ul>`; 
        }

        // ê±°ë˜
        function refreshAllUI() { const currentTab = document.querySelector('.nav-item.text-blue-600')?.dataset.tab; if (tabRenderFunctions[currentTab]) tabRenderFunctions[currentTab](); updateAllPrices(); }
        function loadCryptoUI(symbol, currentPrice, currency) { const tradeUiHtml = getTradeUiHtml(currentPrice, currency, symbol); detailContentContainer.innerHTML = `<div id="chart-container" class="w-full" style="height: 400px;"></div> ${tradeUiHtml}`; if (symbol === 'KKRW') { document.getElementById('chart-container').innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-100 text-gray-500">1,000ì› ê³ ì • ìŠ¤í…Œì´ë¸” ì½”ì¸ì…ë‹ˆë‹¤.</div>`; } else { new TradingView.widget({ "autosize": true, "symbol": symbol, "interval": "60", "timezone": "Asia/Seoul", "theme": "light", "style": "1", "locale": "kr", "container_id": "chart-container" }); } }
        function loadStockUI(symbol, currentPrice, currency) { appState.tradeMode = 'standard'; appState.rwaTradeType = 'spot'; appState.leverage = 1; appState.position = 'long'; const tradeModeSwitcherHtml = `<div class="p-4 bg-gray-100"><div id="trade-mode-toggle" class="relative w-full h-10 bg-gray-300 rounded-lg flex items-center cursor-pointer"><div id="trade-mode-slider" class="absolute h-full w-1/2 bg-white rounded-lg shadow-md transition-transform transform left-0"></div><div class="w-1/2 text-center z-10 font-bold text-blue-600">ê¸°ë³¸ ê±°ë˜</div><div class="w-1/2 text-center z-10 font-semibold text-gray-600">RWA ì²´ì¸ ê±°ë˜</div></div></div>`; const tradeUiHtml = getTradeUiHtml(currentPrice, currency, symbol); detailContentContainer.innerHTML = `${tradeModeSwitcherHtml}<div id="chart-container" class="w-full" style="height: 400px;"></div> ${tradeUiHtml}`; google.charts.setOnLoadCallback(() => drawCandlestickChart(symbol)); }
        function getTradeUiHtml(currentPrice, originalCurrency, symbol) {
            const rwaSubTradeUi = (appState.tradeMode === 'rwa') ? `<div class="space-y-2 mb-2"><label class="font-semibold text-sm">ê±°ë˜ ì¢…ë¥˜</label><div class="grid grid-cols-2 gap-1"><button class="rwa-type-btn p-2 rounded text-sm ${appState.rwaTradeType === 'spot' ? 'bg-blue-600 text-white' : 'bg-gray-200'}" data-type="spot">í˜„ë¬¼</button><button class="rwa-type-btn p-2 rounded text-sm ${appState.rwaTradeType === 'futures' ? 'bg-blue-600 text-white' : 'bg-gray-200'}" data-type="futures">ì„ ë¬¼</button></div></div><div id="leverage-ui-container" class="${appState.rwaTradeType === 'futures' ? '' : 'hidden'}"><div class="space-y-2 mb-2"><label class="font-semibold text-sm">ë ˆë²„ë¦¬ì§€</label><div class="grid grid-cols-3 gap-1"><button class="leverage-btn p-2 rounded text-sm ${appState.leverage === 1 ? 'bg-blue-600 text-white' : 'bg-gray-200'}" data-leverage="1">1x</button><button class="leverage-btn p-2 rounded text-sm ${appState.leverage === 2 ? 'bg-blue-600 text-white' : 'bg-gray-200'}" data-leverage="2">2x</button><button class="leverage-btn p-2 rounded text-sm ${appState.leverage === 3 ? 'bg-blue-600 text-white' : 'bg-gray-200'}" data-leverage="3">3x</button></div></div><div><label class="font-semibold text-sm">í¬ì§€ì…˜</label><div class="grid grid-cols-2 gap-1"><button class="position-btn p-2 rounded text-sm ${appState.position === 'long' ? 'bg-red-600 text-white' : 'bg-gray-200'}" data-position="long">LONG</button><button class="position-btn p-2 rounded text-sm ${appState.position === 'short' ? 'bg-blue-600 text-white' : 'bg-gray-200'}" data-position="short">SHORT</button></div></div></div>` : '';
            let displayInfo, walletCurrency, availableBalance;

            if (appState.tradeMode === 'rwa') {
                const priceInKRW = currentPrice * (exchangeRates[originalCurrency] || 1);
                const priceInKKRW = priceInKRW / exchangeRates.KKRW;
                walletCurrency = 'KKRW';
                availableBalance = userWallet.assets['KKRW']?.quantity || 0;
                displayInfo = { currency: 'KKRW', price: priceInKKRW, wallet: availableBalance };
            } else {
                const assetType = detailView.dataset.assetType;
                const displayCurrency = (appState.displayCurrency === 'Default') ? 'KRW' : appState.displayCurrency;
                if (assetType === 'crypto') { walletCurrency = displayCurrency; availableBalance = userWallet[walletCurrency] || 0; } else { walletCurrency = originalCurrency; availableBalance = userWallet[walletCurrency] || 0; }
                displayInfo = { currency: displayCurrency, price: convertToDisplayCurrency(currentPrice, originalCurrency).value, wallet: availableBalance };
            }

            let asksHtml = '', bidsHtml = '';
            for (let i = 3; i > 0; i--) {
                const askOriginalPrice = currentPrice * (1 + 0.001 * i);
                const bidOriginalPrice = currentPrice * (1 - 0.001 * i);
                let askDisplayValue, bidDisplayValue, secondaryAskHtml = '', secondaryBidHtml = '';

                if (appState.tradeMode === 'rwa') {
                    askDisplayValue = (askOriginalPrice * (exchangeRates[originalCurrency] || 1)) / exchangeRates.KKRW;
                    bidDisplayValue = (bidOriginalPrice * (exchangeRates[originalCurrency] || 1)) / exchangeRates.KKRW;
                    if (appState.displayCurrency !== 'KKRW') {
                        const convertedAsk = convertToDisplayCurrency(askDisplayValue * exchangeRates.KKRW, 'KRW');
                        secondaryAskHtml = `<span class="text-gray-400 font-normal text-xs">(${convertedAsk.value.toLocaleString(undefined, { maximumFractionDigits: 0 })} ${convertedAsk.currency})</span>`;
                        const convertedBid = convertToDisplayCurrency(bidDisplayValue * exchangeRates.KKRW, 'KRW');
                        secondaryBidHtml = `<span class="text-gray-400 font-normal text-xs">(${convertedBid.value.toLocaleString(undefined, { maximumFractionDigits: 0 })} ${convertedBid.currency})</span>`;
                    }
                } else {
                    askDisplayValue = convertToDisplayCurrency(askOriginalPrice, originalCurrency).value;
                    bidDisplayValue = convertToDisplayCurrency(bidOriginalPrice, originalCurrency).value;
                }

                asksHtml += `<div class="flex items-center text-sm text-blue-600 border-b h-10"><div class="w-1/2 text-center leading-tight">${askDisplayValue.toLocaleString(undefined, { maximumFractionDigits: 2 })}<br>${secondaryAskHtml}</div><div class="w-1/2 text-right pr-2">${(Math.random() * 5).toFixed(2)}</div></div>`;
                bidsHtml += `<div class="flex items-center text-sm text-red-600 border-b h-10"><div class="w-1/2 text-center leading-tight">${bidDisplayValue.toLocaleString(undefined, { maximumFractionDigits: 2 })}<br>${secondaryBidHtml}</div><div class="w-1/2 text-right pr-2">${(Math.random() * 5).toFixed(2)}</div></div>`;
            }

            let secondaryPriceHtml = '';
            if (appState.tradeMode === 'rwa' && appState.displayCurrency !== 'KKRW') {
                const priceInKRW = displayInfo.price * exchangeRates.KKRW;
                const converted = convertToDisplayCurrency(priceInKRW, 'KRW');
                secondaryPriceHtml = `<span class="text-base text-gray-500 font-normal ml-2">(${converted.value.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${converted.currency})</span>`;
            }

            return `<div id="trade-ui-wrapper" class="${appState.tradeMode === 'rwa' ? 'rwa-mode-bg' : ''}">
                        <div class="flex-grow p-2 flex">
                            <div class="w-1/2 pr-1 no-scrollbar overflow-y-auto">
                                ${asksHtml}
                                <div class="h-12 flex items-center justify-center font-bold text-lg text-red-600 border-y-2 border-red-500 my-1">
                                    ${displayInfo.price.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${secondaryPriceHtml}
                                </div>
                                ${bidsHtml}
                            </div>
                            <div class="w-1/2 pl-1">
                                <div class="grid grid-cols-2 gap-1 mb-2">
                                    <button id="buy-toggle" class="p-2 text-white font-bold bg-red-600 rounded">ë§¤ìˆ˜</button>
                                    <button id="sell-toggle" class="p-2 text-gray-700 font-bold bg-gray-200 rounded">ë§¤ë„</button>
                                </div>
                                <div class="space-y-2 text-sm">
                                    ${rwaSubTradeUi}
                                    <div><label id="available-label" class="font-semibold">ì£¼ë¬¸ê°€ëŠ¥</label><p id="available-balance" class="text-right">${displayInfo.wallet?.toLocaleString(undefined, { maximumFractionDigits: 2 }) || 0} ${walletCurrency}</p></div>
                                    <div><label class="font-semibold">ê°€ê²©(${displayInfo.currency})</label><input id="price-input" type="number" class="w-full p-2 border rounded text-right" value="${displayInfo.price.toFixed(2)}"></div>
                                    <div><label class="font-semibold">ìˆ˜ëŸ‰</label><input id="quantity-input" type="number" class="w-full p-2 border rounded text-right" placeholder="ì£¼ë¬¸ ìˆ˜ëŸ‰"></div>
                                    <hr>
                                    <div>
                                        <label class="font-semibold">ì£¼ë¬¸ì´ì•¡</label>
                                        <p id="total-amount" class="text-right font-bold">
                                            <span id="primary-total">0 ${displayInfo.currency}</span>
                                            <span id="secondary-total" class="text-gray-500 font-normal block text-sm"></span>
                                        </p>
                                    </div>
                                    <div class="flex justify-between items-center text-xs">
                                        <label class="text-gray-500">ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ</label>
                                        <p id="trade-fee" class="text-right text-gray-500"></p>
                                    </div>
                                    <button id="order-button" class="w-full p-3 text-white font-bold bg-red-600 rounded mt-2">ë§¤ìˆ˜</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
        }
        function loadSendUI(asset, assetSymbol) { document.getElementById('detail-name').textContent = `ì†¡ê¸ˆí•˜ê¸°: ${asset.name}`; document.getElementById('detail-symbol').textContent = ``; const friendsHtml = mockFriends.map(friend => `<div class="friend-item p-3 border rounded-md cursor-pointer" data-platform="${friend.platform}"><p class="font-semibold">${friend.name}</p><p class="text-sm">${friend.platform === 'kakao' ? 'ì¹´ì¹´ì˜¤ ì¹œêµ¬' : 'ë¼ì¸ ì¹œêµ¬'}</p></div>`).join(''); detailContentContainer.innerHTML = `<div class="p-4 flex flex-col h-full"><div><h2 class="text-lg font-bold text-gray-800 mb-2">ë³´ë‚¼ ìˆ˜ëŸ‰ ì…ë ¥</h2><input type="number" id="send-amount-input" placeholder="ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 border rounded-md mb-2"><p class="text-sm text-gray-600 text-right mb-6">ë³´ìœ ìˆ˜ëŸ‰: ${asset.quantity.toLocaleString()} ${asset.ticker}</p><h2 class="text-lg font-bold text-gray-800 mb-2">ì§€ê°‘ ì£¼ì†Œë¡œ ë³´ë‚´ê¸°</h2><input type="text" placeholder="ë°›ëŠ” ì‚¬ëŒì˜ ì§€ê°‘ ì£¼ì†Œ" class="w-full p-3 border rounded-md mb-6"><h2 class="text-lg font-bold text-gray-800 mb-2">ì¹œêµ¬ì—ê²Œ ë³´ë‚´ê¸°</h2><div class="grid grid-cols-2 gap-2 mb-6">${friendsHtml}</div></div><div class="mt-auto"><button id="send-confirm-btn" data-asset-symbol="${assetSymbol}" class="w-full p-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">ì†¡ê¸ˆ ì™„ë£Œí•˜ê¸°</button></div></div>`; }
        function loadFiatSendUI(asset) { document.getElementById('detail-name').textContent = `ì†¡ê¸ˆí•˜ê¸°: ${asset.name}`; document.getElementById('detail-symbol').textContent = ``; const friendsHtml = mockFriends.map(friend => `<div class="friend-item p-3 border rounded-md cursor-pointer" data-platform="${friend.platform}"><p class="font-semibold">${friend.name}</p><p class="text-sm">${friend.platform === 'kakao' ? 'ì¹´ì¹´ì˜¤ ì¹œêµ¬' : 'ë¼ì¸ ì¹œêµ¬'}</p></div>`).join(''); detailContentContainer.innerHTML = `<div class="p-4 flex flex-col h-full"><div><h2 class="text-lg font-bold text-gray-800 mb-2">ë³´ë‚¼ ê¸ˆì•¡ ì…ë ¥</h2><input type="number" id="send-amount-input" placeholder="ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full p-3 border rounded-md mb-2"><p class="text-sm text-gray-600 text-right mb-6">ë³´ìœ ê¸ˆì•¡: ${asset.quantity.toLocaleString()} ${asset.ticker}</p><h2 class="text-lg font-bold text-gray-800 mb-2">ê³„ì¢Œë²ˆí˜¸ë¡œ ë³´ë‚´ê¸°</h2><input type="text" placeholder="ë°›ëŠ” ì‚¬ëŒì˜ ê³„ì¢Œë²ˆí˜¸" class="w-full p-3 border rounded-md mb-6"><h2 class="text-lg font-bold text-gray-800 mb-2">ì¹œêµ¬ì—ê²Œ ë³´ë‚´ê¸°</h2><div class="grid grid-cols-2 gap-2 mb-6">${friendsHtml}</div></div><div class="mt-auto"><button id="send-confirm-btn" data-asset-symbol="${asset.ticker}" class="w-full p-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">ì†¡ê¸ˆ ì™„ë£Œí•˜ê¸°</button></div></div>`; }
        function loadStakingUI(symbol) {
            const assetInfo = mockApi.basePrices[symbol];
            const availableAsset = userWallet.assets[symbol];
            const availableQuantity = availableAsset ? availableAsset.quantity : 0;
            
            document.getElementById('detail-name').textContent = `ìŠ¤í…Œì´í‚¹: ${assetInfo.name}`;
            document.getElementById('detail-symbol').textContent = symbol;
            mainView.classList.add('hidden');
            detailView.classList.remove('hidden');

            const baseApy = assetInfo.apy;
            const boostedApy = baseApy + 0.2;

            let kaiaBonusHtml = '';
            let kaiaBonusClasses = '';
            if (symbol === 'BITHUMB:KAIAKRW') {
                kaiaBonusClasses = 'border-dashed border-2 border-amber-500';
                kaiaBonusHtml = `<div class="mt-2 p-2 bg-amber-100 text-amber-800 text-xs rounded-md text-center">âœ¨ KAIA 500ê°œ ì´ìƒ 14ì¼ ìŠ¤í…Œì´í‚¹í•˜ë©´ <strong>íŠ¹ë³„ í˜œíƒ</strong>ì´ ì œê³µë©ë‹ˆë‹¤!</div>`;
            }

            const contentHtml = `
                <div class="p-4 space-y-6">
                    <div>
                        <label class="font-semibold text-gray-700">ìˆ˜ëŸ‰ ì…ë ¥</label>
                        <div class="flex items-center mt-1">
                            <input type="number" id="stake-quantity-input" placeholder="ìŠ¤í…Œì´í‚¹í•  ìˆ˜ëŸ‰" class="w-full p-3 border rounded-l-md">
                            <button id="stake-max-btn" class="bg-gray-200 px-4 py-3 rounded-r-md font-semibold text-sm">ìµœëŒ€</button>
                        </div>
                        <p class="text-sm text-gray-600 text-right mt-1">ì‚¬ìš© ê°€ëŠ¥: ${availableQuantity.toLocaleString()} ${availableAsset.ticker}</p>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-700">ê¸°ê°„ ì„ íƒ</p>
                        <div class="mt-2 grid grid-cols-2 gap-2" id="stake-duration-options">
                            <button class="stake-duration-btn border-2 border-blue-500 bg-blue-100 text-blue-700 p-3 rounded-md font-bold text-center" data-duration="7" data-apy="${baseApy}">
                                7ì¼<br><span class="text-xs font-normal">ì—° ${baseApy.toFixed(1)}%</span>
                            </button>
                            <button class="stake-duration-btn border p-3 rounded-md text-center font-bold ${kaiaBonusClasses}" data-duration="14" data-apy="${boostedApy}">
                                14ì¼<br><span class="text-xs font-normal">ì—° ${boostedApy.toFixed(1)}%</span>
                            </button>
                        </div>
                        ${kaiaBonusHtml}
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="font-semibold text-gray-800">ì˜ˆìƒ ë³´ìƒ</p>
                        <p id="estimated-rewards" class="text-right font-bold text-lg text-purple-600">0 ${availableAsset.ticker}</p>
                    </div>
                    <button id="confirm-stake-btn" data-symbol="${symbol}" class="w-full p-4 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700">
                        ìŠ¤í…Œì´í‚¹ í™•ì •í•˜ê¸°
                    </button>
                </div>`;
            detailContentContainer.innerHTML = contentHtml;
            document.getElementById('stake-quantity-input').dispatchEvent(new Event('input'));
        }
        function drawCandlestickChart(symbol) { const data = google.visualization.arrayToDataTable(mockCandleData(symbol), true); const options = { legend: 'none', candlestick: { fallingColor: { strokeWidth: 0, fill: '#00F' }, risingColor: { strokeWidth: 0, fill: '#F00' }}, hAxis: { textPosition: 'none' }, vAxis: { gridlines: { color: '#f0f0f0' } } }; const chart = new google.visualization.CandlestickChart(document.getElementById('chart-container')); chart.draw(data, options); }
        function mockCandleData(symbol) { const data = []; let lastClose = mockApi.basePrices[symbol]?.price || 50000; for (let i = 0; i < 60; i++) { const date = new Date(); date.setDate(date.getDate() - (60 - i)); const f = lastClose * 0.05, o = lastClose + (Math.random() - 0.5) * f, c = o + (Math.random() - 0.5) * f, h = Math.max(o, c) + Math.random() * (f*0.5), l = Math.min(o, c) - Math.random() * (f*0.5); data.push([date, l, o, c, h]); lastClose = c; } return data; }
        function drawPerformanceChart() { const data = google.visualization.arrayToDataTable([ ['ì›”', 'ê°€ì¹˜'], ['1ì›”', 1000], ['2ì›”', 1170], ['3ì›”', 1260], ['4ì›”', 1330], ['5ì›”', 1400], ['6ì›”', 1530], ['7ì›”', 1600], ['8ì›”', 1720] ]); const options = { title: 'í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì¹˜ ì¶”ì´ (KRW)', curveType: 'function', legend: { position: 'bottom' }, hAxis: { textPosition: 'none' }, vAxis: { format: 'short' } }; const chart = new google.visualization.LineChart(document.getElementById('performance-chart')); chart.draw(data, options); }
        function drawAllocationChart() { const portfolioData = [['ìì‚°', 'ê°€ì¹˜ (KRW)']]; portfolioData.push(['KRW', userWallet.KRW]); portfolioData.push(['JPY', userWallet.JPY * exchangeRates.JPY]); for (const symbol in userWallet.assets) { const asset = userWallet.assets[symbol]; const baseInfo = mockApi.basePrices[asset.rwaOriginalSymbol || symbol]; if (baseInfo) { const valueInKRW = asset.quantity * baseInfo.price * (exchangeRates[baseInfo.currency] || 1); portfolioData.push([asset.ticker, valueInKRW]); } } const options = { title: 'ìì‚° ë°°ë¶„ (KRW ê¸°ì¤€)', pieHole: 0.4 }; const chart = new google.visualization.PieChart(document.getElementById('allocation-chart')); chart.draw(google.visualization.arrayToDataTable(portfolioData), options); }

        const tabRenderFunctions = { search: renderSearchUI, history: renderHistoryUI, transfer: renderAssetsUI, more: renderSettingsUI };
        
        document.addEventListener('DOMContentLoaded', () => {
            const appContainer = document.getElementById('app-container');
            appContainer.addEventListener('click', (e) => {
                const target = e.target;
                const closest = (selector) => target.closest(selector);

                if (closest('#back-button')) { detailView.classList.add('hidden'); mainView.classList.remove('hidden'); detailContentContainer.innerHTML = ''; document.querySelector('.nav-item.text-blue-600').click(); return; }
                const navItem = closest('.nav-item'); if (navItem) { const tabId = navItem.dataset.tab; document.getElementById('header-title').textContent = navItem.dataset.title; document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden')); document.getElementById(tabId + '-content').classList.remove('hidden'); if (tabRenderFunctions[tabId]) tabRenderFunctions[tabId](); document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('text-blue-600'); n.classList.add('text-gray-500'); n.querySelector('p').classList.remove('font-semibold'); }); navItem.classList.add('text-blue-600'); navItem.querySelector('p').classList.add('font-semibold'); return; }
                const assetItem = closest('.asset-item'); if (assetItem) { const { type, symbol, name } = assetItem.dataset; let currency = assetItem.dataset.currency; const basePrice = mockApi.basePrices[symbol]?.price || 0; const originalCurrency = mockApi.basePrices[symbol]?.currency || currency; document.getElementById('detail-name').textContent = name; document.getElementById('detail-symbol').textContent = symbol; detailView.dataset.assetType = type; mainView.classList.add('hidden'); detailView.classList.remove('hidden'); if (type === 'crypto') loadCryptoUI(symbol, basePrice, originalCurrency); else if (type === 'stock') loadStockUI(symbol, basePrice, originalCurrency); return; }
                const buyToggle = closest('#buy-toggle'); if(buyToggle) { const tradeUI = closest('.w-1\\/2.pl-1'), symbol = document.getElementById('detail-symbol').textContent; const assetType = detailView.dataset.assetType; let balance, balanceCurrency; if (appState.tradeMode === 'rwa') { balanceCurrency = 'KKRW'; balance = userWallet.assets['KKRW']?.quantity || 0; } else { if (assetType === 'crypto') { balanceCurrency = (appState.displayCurrency === 'Default') ? 'KRW' : appState.displayCurrency; balance = userWallet[balanceCurrency] || 0; } else { balanceCurrency = mockApi.basePrices[symbol].currency; balance = userWallet[balanceCurrency] || 0; } } tradeUI.querySelector('#buy-toggle').className = 'p-2 text-white font-bold bg-red-600 rounded'; tradeUI.querySelector('#sell-toggle').className = 'p-2 text-gray-700 font-bold bg-gray-200 rounded'; tradeUI.querySelector('#order-button').className = 'w-full p-3 text-white font-bold bg-red-600 rounded mt-2'; tradeUI.querySelector('#order-button').textContent = 'ë§¤ìˆ˜'; tradeUI.querySelector('#available-label').textContent = 'ì£¼ë¬¸ê°€ëŠ¥'; tradeUI.querySelector('#available-balance').textContent = `${balance?.toLocaleString(undefined, {maximumFractionDigits:2}) || 0} ${balanceCurrency}`; return; }
                const sellToggle = closest('#sell-toggle'); if (sellToggle) { const tradeUI = closest('.w-1\\/2.pl-1'), symbol = document.getElementById('detail-symbol').textContent; tradeUI.querySelector('#sell-toggle').className = 'p-2 text-white font-bold bg-blue-600 rounded'; tradeUI.querySelector('#buy-toggle').className = 'p-2 text-gray-700 font-bold bg-gray-200 rounded'; tradeUI.querySelector('#order-button').className = 'w-full p-3 text-white font-bold bg-blue-600 rounded mt-2'; tradeUI.querySelector('#order-button').textContent = 'ë§¤ë„'; const ownedAsset = userWallet.assets[symbol] || Object.values(userWallet.assets).find(a => a.rwaOriginalSymbol === symbol); const quantity = ownedAsset ? ownedAsset.quantity : 0; const ticker = ownedAsset ? ownedAsset.ticker : (mockApi.basePrices[symbol]?.name.split(' ')[0] || symbol); tradeUI.querySelector('#available-label').textContent = 'ë§¤ë„ê°€ëŠ¥'; tradeUI.querySelector('#available-balance').textContent = `${quantity.toLocaleString()} ê°œ`; return; }
                const orderButton = closest('#order-button'); if (orderButton) { const tradeUI = closest('.w-1\\/2.pl-1'), symbol = document.getElementById('detail-symbol').textContent, type = detailView.dataset.assetType; const quantity = parseFloat(tradeUI.querySelector('#quantity-input').value); const priceInDisplayCurrency = parseFloat(tradeUI.querySelector('#price-input').value); if (isNaN(quantity) || quantity <= 0) { alert('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; } if (appState.tradeMode === 'standard' && type === 'stock' && quantity % 1 !== 0) { alert('ì¼ë°˜ ì£¼ì‹ ê±°ë˜ëŠ” ì†Œìˆ˜ì  ë‹¨ìœ„ë¡œ ê±°ë˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; } if (appState.tradeMode === 'rwa') { const priceInKKRW = priceInDisplayCurrency; const totalAmountInKKRW = priceInKKRW * quantity; const fee = totalAmountInKKRW * FEE_RATES.RWA; if (orderButton.textContent === 'ë§¤ìˆ˜') { const totalWithFee = totalAmountInKKRW + fee; const kkrwWallet = userWallet.assets['KKRW']; if (!kkrwWallet || kkrwWallet.quantity < totalWithFee) { alert('KKRW ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; } kkrwWallet.quantity -= totalWithFee; const originalAssetInfo = userWallet.assets[symbol] || mockApi.basePrices[symbol]; let rwaSymbol, rwaName, rwaTicker; if (appState.rwaTradeType === 'spot') { rwaSymbol = `RWA-SPOT:${symbol}`; rwaName = `[RWA í˜„ë¬¼] ${originalAssetInfo.name}`; rwaTicker = `KA-${originalAssetInfo.ticker || originalAssetInfo.name.split(' ')[0]}`; } else { rwaSymbol = `RWA-FUTURES-${appState.leverage}-${appState.position}:${symbol}`; rwaName = `[RWA ì„ ë¬¼] (${appState.leverage}x ${appState.position.toUpperCase()}) ${originalAssetInfo.name}`; rwaTicker = `KA-${originalAssetInfo.ticker || originalAssetInfo.name.split(' ')[0]}-${appState.leverage}${appState.position[0].toUpperCase()}`; } if (userWallet.assets[rwaSymbol]) { userWallet.assets[rwaSymbol].quantity += quantity; } else { userWallet.assets[rwaSymbol] = { name: rwaName, ticker: rwaTicker, quantity: quantity, rwaOriginalSymbol: symbol, isSpot: appState.rwaTradeType === 'spot' }; } alert(`RWA ë§¤ìˆ˜ ì²´ê²° ì™„ë£Œ! (ìˆ˜ìˆ˜ë£Œ: ${fee.toFixed(4)} KKRW)`); closest('#buy-toggle').click(); } else { const netAmount = totalAmountInKKRW - fee; let rwaSymbolToSell; if (appState.rwaTradeType === 'spot') { rwaSymbolToSell = `RWA-SPOT:${symbol}`; } else { rwaSymbolToSell = `RWA-FUTURES-${appState.leverage}-${appState.position}:${symbol}`; } const ownedRwaAsset = userWallet.assets[rwaSymbolToSell]; if (!ownedRwaAsset || ownedRwaAsset.quantity < quantity) { alert('ë§¤ë„ ê°€ëŠ¥í•œ RWA í† í° ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; } ownedRwaAsset.quantity -= quantity; if (userWallet.assets['KKRW']) { userWallet.assets['KKRW'].quantity += netAmount; } else { userWallet.assets['KKRW'] = { name: 'KKRW', ticker: 'KKRW', quantity: netAmount }; } if (ownedRwaAsset.quantity < 1e-9) { delete userWallet.assets[rwaSymbolToSell]; } alert(`RWA ë§¤ë„ ì²´ê²° ì™„ë£Œ! ${netAmount.toFixed(2)} KKRWê°€ ì…ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤. (ìˆ˜ìˆ˜ë£Œ: ${fee.toFixed(4)} KKRW)`); closest('#sell-toggle').click(); } } else { const assetType = detailView.dataset.assetType; let transactionCurrency, totalAmountInTransactionCurrency, fee; const feeRate = assetType === 'stock' ? FEE_RATES.STOCK : FEE_RATES.CRYPTO; if (assetType === 'crypto') { transactionCurrency = (appState.displayCurrency === 'Default') ? 'KRW' : appState.displayCurrency; totalAmountInTransactionCurrency = priceInDisplayCurrency * quantity; fee = totalAmountInTransactionCurrency * feeRate; } else { transactionCurrency = mockApi.basePrices[symbol].currency; const priceInOriginalCurrency = (appState.displayCurrency === 'Default' || appState.displayCurrency === transactionCurrency) ? priceInDisplayCurrency : priceInDisplayCurrency * (exchangeRates[appState.displayCurrency] || 1) / (exchangeRates[transactionCurrency] || 1); totalAmountInTransactionCurrency = priceInOriginalCurrency * quantity; fee = totalAmountInTransactionCurrency * feeRate; } if (orderButton.textContent === 'ë§¤ìˆ˜') { const totalWithFee = totalAmountInTransactionCurrency + fee; if ((userWallet[transactionCurrency] || 0) < totalWithFee) { alert('ì£¼ë¬¸ê°€ëŠ¥ ê¸ˆì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; } userWallet[transactionCurrency] -= totalWithFee; if (userWallet.assets[symbol]) { userWallet.assets[symbol].quantity += quantity; } else { const name = document.getElementById('detail-name').textContent; const ticker = symbol.includes(':') ? symbol.split(':')[1].replace('KRW','') : symbol.split('.')[0]; userWallet.assets[symbol] = { name, ticker, quantity }; } alert(`${quantity}ì£¼(ê°œ) ë§¤ìˆ˜ ì²´ê²° ì™„ë£Œ! (ìˆ˜ìˆ˜ë£Œ: ${fee.toFixed(4)} ${transactionCurrency})`); closest('#buy-toggle').click(); } else { const netAmount = totalAmountInTransactionCurrency - fee; const ownedAsset = userWallet.assets[symbol]; if (!ownedAsset || ownedAsset.quantity < quantity) { alert('ë§¤ë„ ê°€ëŠ¥ ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; } ownedAsset.quantity -= quantity; userWallet[transactionCurrency] += netAmount; alert(`${quantity}ì£¼(ê°œ) ë§¤ë„ ì²´ê²° ì™„ë£Œ! (ìˆ˜ìˆ˜ë£Œ: ${fee.toFixed(4)} ${transactionCurrency})`); closest('#sell-toggle').click(); } } return; }
                const sendConfirmBtn = closest('#send-confirm-btn'); if (sendConfirmBtn) { const amountToSend = parseFloat(document.getElementById('send-amount-input').value); const assetSymbol = sendConfirmBtn.dataset.assetSymbol; if (isNaN(amountToSend) || amountToSend <= 0) { alert('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; } if (userWallet.assets[assetSymbol]) { if (amountToSend > userWallet.assets[assetSymbol].quantity) { alert('ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; } userWallet.assets[assetSymbol].quantity -= amountToSend; alert(`${amountToSend} ${userWallet.assets[assetSymbol].ticker} ì†¡ê¸ˆì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në‚¨ì€ ìˆ˜ëŸ‰: ${userWallet.assets[assetSymbol].quantity.toLocaleString()}`); } else { if (amountToSend > userWallet[assetSymbol]) { alert('ë³´ìœ  ê¸ˆì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; } userWallet[assetSymbol] -= amountToSend; alert(`${amountToSend.toLocaleString()} ${assetSymbol} ì†¡ê¸ˆì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në‚¨ì€ ê¸ˆì•¡: ${userWallet[assetSymbol].toLocaleString()}`); } detailView.classList.add('hidden'); mainView.classList.remove('hidden'); const transferTab = document.querySelector('.nav-item[data-tab="transfer"]'); transferTab.click(); return; }
                const friendItem = closest('.friend-item'); if(friendItem) { document.querySelectorAll('.friend-item').forEach(el => el.classList.remove('selected-kakao', 'selected-line')); const platformClass = friendItem.dataset.platform === 'kakao' ? 'selected-kakao' : 'selected-line'; friendItem.classList.add(platformClass); return; }
                
                const stakeBtn = closest('.stake-btn'); if (stakeBtn) { loadStakingUI(stakeBtn.dataset.assetSymbol); return; }
                const stakeMaxBtn = closest('#stake-max-btn'); if(stakeMaxBtn) { const symbol = document.getElementById('detail-symbol').textContent; const availableQuantity = userWallet.assets[symbol]?.quantity || 0; document.getElementById('stake-quantity-input').value = availableQuantity; document.getElementById('stake-quantity-input').dispatchEvent(new Event('input')); return; }
                const stakeDurationBtn = closest('.stake-duration-btn'); if (stakeDurationBtn) { document.querySelectorAll('.stake-duration-btn').forEach(btn => { btn.classList.remove('border-blue-500', 'bg-blue-100', 'text-blue-700'); btn.classList.add('border'); }); stakeDurationBtn.classList.add('border-blue-500', 'bg-blue-100', 'text-blue-700'); stakeDurationBtn.classList.remove('border'); document.getElementById('stake-quantity-input').dispatchEvent(new Event('input')); return; }
                const confirmStakeBtn = closest('#confirm-stake-btn'); if (confirmStakeBtn) { const symbol = confirmStakeBtn.dataset.symbol; const quantity = parseFloat(document.getElementById('stake-quantity-input').value); const selectedDurationBtn = document.querySelector('.stake-duration-btn.border-blue-500'); const duration = parseInt(selectedDurationBtn.dataset.duration); const apy = parseFloat(selectedDurationBtn.dataset.apy); const asset = userWallet.assets[symbol]; if (isNaN(quantity) || quantity <= 0) { alert('ì˜¬ë°”ë¥¸ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; } if (!asset || asset.quantity < quantity) { alert('ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; } asset.quantity -= quantity; if(asset.quantity < 1e-9) delete userWallet.assets[symbol]; userWallet.stakedAssets.push({ symbol: symbol, quantity: quantity, startDate: Date.now(), duration: duration, apy: apy }); alert(`${quantity.toLocaleString()} ${asset.ticker}ë¥¼ ${duration}ì¼ê°„ ìŠ¤í…Œì´í‚¹ ì‹œì‘í•©ë‹ˆë‹¤.`); detailView.classList.add('hidden'); mainView.classList.remove('hidden'); detailContentContainer.innerHTML = ''; const assetsTab = document.querySelector('.nav-item[data-tab="transfer"]'); if (assetsTab) { assetsTab.click(); } return; }
                const unstakeBtn = closest('.unstake-btn'); if (unstakeBtn) { const confirmed = confirm('ìŠ¤í…Œì´í‚¹ì„ ì¤‘ë„ í•´ì§€í•˜ë©´ ë³´ìƒì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ë§ í•´ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'); if(confirmed) { const index = parseInt(unstakeBtn.dataset.stakeIndex); const stakedAsset = userWallet.stakedAssets.splice(index, 1)[0]; if(userWallet.assets[stakedAsset.symbol]) { userWallet.assets[stakedAsset.symbol].quantity += stakedAsset.quantity; } else { const originalAsset = mockApi.basePrices[stakedAsset.symbol]; userWallet.assets[stakedAsset.symbol] = { name: originalAsset.name, ticker: originalAsset.name.split(' ')[0], quantity: stakedAsset.quantity }; } renderSettingsUI(); } return; }
                const sendBtn = closest('.send-btn'); if(sendBtn) { const assetSymbol = sendBtn.dataset.assetSymbol; const assetData = userWallet.assets[assetSymbol]; mainView.classList.add('hidden'); detailView.classList.remove('hidden'); loadSendUI(assetData, assetSymbol); return; }
                const fiatSendBtn = closest('.fiat-send-btn'); if(fiatSendBtn) { const assetSymbol = fiatSendBtn.dataset.assetSymbol; const assetData = {name: assetSymbol === 'KRW' ? 'ëŒ€í•œë¯¼êµ­ ì›' : 'ì¼ë³¸ ì—”', ticker: assetSymbol, quantity: userWallet[assetSymbol]}; mainView.classList.add('hidden'); detailView.classList.remove('hidden'); loadFiatSendUI(assetData); return; }
                const currencyBtn = closest('.currency-btn'); if(currencyBtn) { appState.displayCurrency = currencyBtn.dataset.currency; refreshAllUI(); return; }
                const linkBtn = closest('.link-account-btn'); if(linkBtn) { appState.linkedAccounts[linkBtn.dataset.platform] = !appState.linkedAccounts[linkBtn.dataset.platform]; renderSettingsUI(); return; }
                const tradeModeToggle = closest('#trade-mode-toggle'); if(tradeModeToggle) { appState.tradeMode = appState.tradeMode === 'standard' ? 'rwa' : 'standard'; appState.rwaTradeType = 'spot'; const slider = document.getElementById('trade-mode-slider'); const labels = tradeModeToggle.querySelectorAll('div.z-10'); const tradeUiWrapper = document.getElementById('trade-ui-wrapper'); const symbol = document.getElementById('detail-symbol').textContent; const currency = mockApi.basePrices[symbol].currency; const currentPrice = mockApi.basePrices[symbol].price; if(appState.tradeMode === 'rwa') { slider.classList.remove('left-0'); slider.classList.add('left-1/2'); labels[0].classList.remove('text-blue-600', 'font-bold'); labels[0].classList.add('text-gray-600', 'font-semibold'); labels[1].classList.add('text-blue-600', 'font-bold'); labels[1].classList.remove('text-gray-600', 'font-semibold'); } else { slider.classList.remove('left-1/2'); slider.classList.add('left-0'); labels[1].classList.remove('text-blue-600', 'font-bold'); labels[1].classList.add('text-gray-600', 'font-semibold'); labels[0].classList.add('text-blue-600', 'font-bold'); labels[0].classList.remove('text-gray-600', 'font-semibold'); } const newTradeUiHtml = getTradeUiHtml(currentPrice, currency, symbol); tradeUiWrapper.outerHTML = newTradeUiHtml; return; }
                const swapBtn = closest('.swap-rwa-btn'); if (swapBtn) { const listItem = swapBtn.closest('li'); const rwaSymbol = listItem.dataset.rwaSymbol; listItem.innerHTML = `<div class="w-full flex items-center space-x-2"><input type="number" class="swap-quantity-input w-full p-2 border rounded" placeholder="ìˆ˜ëŸ‰ ì…ë ¥"><button class="max-swap-btn bg-gray-200 px-3 py-2 text-sm rounded" data-rwa-symbol="${rwaSymbol}">ìµœëŒ€</button><button class="confirm-swap-btn bg-green-500 text-white px-3 py-2 text-sm rounded font-bold" data-rwa-symbol="${rwaSymbol}">í™•ì •</button><button class="cancel-swap-btn bg-gray-400 text-white px-3 py-2 text-sm rounded">ì·¨ì†Œ</button></div>`; return; }
                const confirmSwapBtn = closest('.confirm-swap-btn'); if(confirmSwapBtn) { const rwaSymbol = confirmSwapBtn.dataset.rwaSymbol; const rwaAsset = userWallet.assets[rwaSymbol]; const quantityToSwap = parseFloat(closest('li').querySelector('.swap-quantity-input').value); if (isNaN(quantityToSwap) || quantityToSwap <= 0) { alert('ì˜¬ë°”ë¥¸ êµí™˜ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; } const integerQuantity = Math.floor(quantityToSwap); if (integerQuantity === 0) { alert('êµí™˜ ìˆ˜ëŸ‰ì€ ë°˜ë“œì‹œ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; } if (rwaAsset && rwaAsset.quantity >= integerQuantity) { const originalSymbol = rwaAsset.rwaOriginalSymbol; if(userWallet.assets[originalSymbol]) { userWallet.assets[originalSymbol].quantity += integerQuantity; } else { const originalAssetInfo = mockApi.basePrices[originalSymbol]; userWallet.assets[originalSymbol] = { name: originalAssetInfo.name, ticker: (originalAssetInfo.name.split(' ')[0]), quantity: integerQuantity }; } rwaAsset.quantity -= integerQuantity; if (rwaAsset.quantity < 1e-9) { delete userWallet.assets[rwaSymbol]; } alert(`${rwaAsset.name} ${integerQuantity}ê°œê°€ ì‹¤ë¬¼ ìì‚°ìœ¼ë¡œ êµí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`); renderSettingsUI(); } else { alert('ë³´ìœ  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'); } return; }
                const cancelSwapBtn = closest('.cancel-swap-btn'); if(cancelSwapBtn) { renderSettingsUI(); return; }
                const maxSwapBtn = closest('.max-swap-btn'); if(maxSwapBtn) { const rwaSymbol = maxSwapBtn.dataset.rwaSymbol; const rwaAsset = userWallet.assets[rwaSymbol]; if(rwaAsset) { const inputEl = maxSwapBtn.closest('li').querySelector('.swap-quantity-input'); inputEl.value = Math.floor(rwaAsset.quantity); } return; }
                const leverageBtn = closest('.leverage-btn'); if(leverageBtn) { appState.leverage = parseInt(leverageBtn.dataset.leverage); const buttons = closest('.grid').querySelectorAll('.leverage-btn'); buttons.forEach(btn => { btn.classList.remove('bg-blue-600', 'text-white'); btn.classList.add('bg-gray-200'); }); leverageBtn.classList.add('bg-blue-600', 'text-white'); leverageBtn.classList.remove('bg-gray-200'); return; }
                const positionBtn = closest('.position-btn'); if(positionBtn) { appState.position = positionBtn.dataset.position; const buttons = closest('.grid').querySelectorAll('.position-btn'); buttons.forEach(btn => { btn.classList.remove('bg-red-600', 'bg-blue-600', 'text-white'); btn.classList.add('bg-gray-200'); }); positionBtn.classList.add(appState.position === 'long' ? 'bg-red-600' : 'bg-blue-600', 'text-white'); positionBtn.classList.remove('bg-gray-200'); return; }
                const rwaTypeBtn = closest('.rwa-type-btn'); if (rwaTypeBtn) { appState.rwaTradeType = rwaTypeBtn.dataset.type; const tradeUiWrapper = document.getElementById('trade-ui-wrapper'); const symbol = document.getElementById('detail-symbol').textContent; const currency = mockApi.basePrices[symbol].currency; const currentPrice = mockApi.basePrices[symbol].price; const newTradeUiHtml = getTradeUiHtml(currentPrice, currency, symbol); tradeUiWrapper.outerHTML = newTradeUiHtml; return; }
            });
            
            appContainer.addEventListener('input', (e) => {
                const target = e.target;
                if (target.matches('#search-input')) { const allStocks = Object.entries(mockApi.basePrices).filter(([, data]) => data.type === 'stock').map(([symbol, data]) => ({...data, symbol})); const filteredAssets = allStocks.filter(asset => Hangul.includes(asset.name, target.value)); displaySearchResults(filteredAssets); return; }
                if (target.matches('#price-input, #quantity-input')) {
                    const price = parseFloat(document.getElementById('price-input').value) || 0;
                    const quantity = parseFloat(document.getElementById('quantity-input').value) || 0;
                    const total = price * quantity;
                    const primaryTotalEl = document.getElementById('primary-total');
                    const secondaryTotalEl = document.getElementById('secondary-total');
                    const tradeFeeEl = document.getElementById('trade-fee');
                    const assetType = detailView.dataset.assetType;

                    if (!primaryTotalEl) return;

                    const currency = primaryTotalEl.textContent.split(' ')[1] || 'KRW';
                    primaryTotalEl.textContent = `${total.toLocaleString(undefined, { maximumFractionDigits: 0 })} ${currency}`;
                    
                    let fee = 0;
                    let feeRate = 0;
                    if (appState.tradeMode === 'rwa') {
                        feeRate = FEE_RATES.RWA;
                        fee = total * feeRate;
                    } else {
                        feeRate = assetType === 'stock' ? FEE_RATES.STOCK : FEE_RATES.CRYPTO;
                        fee = total * feeRate;
                    }

                    if (tradeFeeEl) {
                        tradeFeeEl.textContent = `${fee.toFixed(8)} ${currency}`;
                    }
                    
                    if (secondaryTotalEl) {
                        secondaryTotalEl.textContent = ''; 
                        if (appState.tradeMode === 'rwa' && appState.displayCurrency !== 'KKRW') {
                            const totalInKRW = total * exchangeRates.KKRW;
                            const converted = convertToDisplayCurrency(totalInKRW, 'KRW');
                            secondaryTotalEl.textContent = `(${converted.value.toLocaleString(undefined, { maximumFractionDigits: 2 })} ${converted.currency})`;
                        }
                    }
                    return;
                }
                if (target.matches('#stake-quantity-input')) {
                    const quantity = parseFloat(target.value) || 0;
                    const symbol = document.getElementById('detail-symbol').textContent;
                    const selectedDurationBtn = document.querySelector('.stake-duration-btn.border-blue-500');
                    if (!selectedDurationBtn) return;
                    const duration = parseInt(selectedDurationBtn.dataset.duration);
                    const apy = parseFloat(selectedDurationBtn.dataset.apy);
                    const reward = quantity * (apy / 100) * (duration / 365);
                    const asset = userWallet.assets[symbol] || Object.values(userWallet.assets).find(a => a.ticker === symbol.split(':')[1].replace('KRW', ''));
                    document.getElementById('estimated-rewards').textContent = `${reward.toFixed(8)} ${asset.ticker}`;
                }
            });

            updateAllPrices();
        });
    </script>
</body>
</html>
